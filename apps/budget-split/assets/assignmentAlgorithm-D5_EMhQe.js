function x(d){return d.price*(d.quantity||1)}function b(d,m,e,f){const h=d.moneyCap?d.moneyCap-m:1/0,s=f-e;return Math.min(h,s)}function $(d,m,e,f){const h=[],s=[],u=[],a=new Map;d.forEach(l=>a.set(l.id,0));let g=0;const C=[...m].sort((l,E)=>x(E)-x(l));for(const l of C){const E=x(l),o=l.quantity||1;let q=f.get(l.category)||[];if(q.length===0){u.push({...l,quantity:o});continue}if(g+E>e){s.push({...l,quantity:o});continue}if(q=q.filter(t=>{const p=a.get(t.id)||0;return!t.moneyCap||p+E<=t.moneyCap}),q.length===0){s.push({...l,quantity:o});continue}let w=null,k=1/0;for(const t of q){const p=a.get(t.id)||0,I=b(t,p,g,e);I>=E&&I<k&&(k=I,w=t)}if(!w){s.push({...l,quantity:o});continue}h.push({taskId:l.id,employeeId:w.id});const n=a.get(w.id)||0;a.set(w.id,n+E),g+=E}return{assignments:h,unassignedBudgetLimit:s,unassignedNoMatch:u,employeeCompensation:a,totalUsed:g}}function z(d,m,e,f,h,s,u,a,g){const C=new Map;m.forEach(k=>C.set(k.id,k));const l=new Map;e.forEach(k=>l.set(k.taskId,k.employeeId));const E=new Map;d.forEach(k=>E.set(k.id,k));let o=!0;const q=100;let w=0;if(f.length===0)return{assignments:e,unassignedBudgetLimit:f,employeeCompensation:s,totalUsed:u};for(;o&&w<q;){o=!1,w++;const k=[...f].sort((n,t)=>x(t)-x(n));for(const n of k){const t=x(n);let p=null;for(const y of e){const i=C.get(y.taskId);if(!i)continue;const c=x(i),r=E.get(y.employeeId);if(!r||t<=c)continue;const v=(s.get(r.id)||0)-c,V=b(r,v,u-c,a);if(r.categories.includes(n.category)&&V>=t&&(!r.moneyCap||v+t<=r.moneyCap)){const R=t-c;if(!p||R>p.improvement){const N=g.get(i.category)||[];for(const T of N){if(T.id===r.id)continue;const L=s.get(T.id)||0;if(b(T,L,u-c,a)>=c&&(!T.moneyCap||L+c<=T.moneyCap)){p={assignedTask:i,assignedEmployee:r,unassignedEmployee:T,improvement:R};break}}}}}let I=null;const A=g.get(n.category)||[];for(const y of A){const i=s.get(y.id)||0,c=b(y,i,u,a);if(!(c>=t))for(const r of e){if(r.employeeId!==y.id)continue;const M=C.get(r.taskId);if(!M)continue;const v=x(M),V=c+v;if(V>=t){const R=g.get(M.category)||[];for(const N of R){if(N.id===y.id)continue;const T=s.get(N.id)||0;if(b(N,T,u,a)>=v&&(!N.moneyCap||T+v<=N.moneyCap)){const S=V-t;(!I||S<I.createsRoom)&&(I={taskToMove:M,fromEmployee:y,toEmployee:N,createsRoom:S})}}}}}if(p&&p.improvement>0){const{assignedTask:y,assignedEmployee:i,unassignedEmployee:c}=p,r=e.findIndex(R=>R.taskId===y.id&&R.employeeId===i.id);r>=0&&e.splice(r,1);const M=s.get(i.id)||0;s.set(i.id,M-x(y)+t),e.push({taskId:n.id,employeeId:i.id}),e.push({taskId:y.id,employeeId:c.id});const v=s.get(c.id)||0;s.set(c.id,v+x(y)),u=u-x(y)+t;const V=f.findIndex(R=>R.id===n.id);V>=0&&f.splice(V,1),o=!0;break}else if(I){const{taskToMove:y,fromEmployee:i,toEmployee:c}=I,r=e.findIndex(T=>T.taskId===y.id&&T.employeeId===i.id);r>=0&&(e[r].employeeId=c.id);const M=s.get(i.id)||0,v=s.get(c.id)||0,V=x(y);s.set(i.id,M-V),s.set(c.id,v+V),e.push({taskId:n.id,employeeId:i.id});const R=s.get(i.id)||0;s.set(i.id,R+t),u+=t;const N=f.findIndex(T=>T.id===n.id);N>=0&&f.splice(N,1),o=!0;break}}}return{assignments:e,unassignedBudgetLimit:f,employeeCompensation:s,totalUsed:u}}const Q=({employees:d,tasks:m,budget:e,strategy:f})=>{const h=new Map;if(d.forEach(n=>{n.categories.forEach(t=>{const p=h.get(t)||[];p.push(n),h.set(t,p)})}),f==="greedy"){const n=$(d,m,e,h),t=z(d,m,n.assignments,n.unassignedBudgetLimit,n.unassignedNoMatch,n.employeeCompensation,n.totalUsed,e,h),p=t.assignments.length,I=t.unassignedBudgetLimit.length+n.unassignedNoMatch.length,A=e>0?t.totalUsed/e*100:0;return{assignments:t.assignments,unassigned:{budgetLimit:t.unassignedBudgetLimit,noMatch:n.unassignedNoMatch},totalUsed:t.totalUsed,statistics:{totalTasks:m.length,assignedTasks:p,unassignedTasks:I,budgetUtilization:A}}}const s=[],u=[],a=[];let g=0;const C=new Map;d.forEach(n=>C.set(n.id,0));const l=[...m].sort((n,t)=>t.price-n.price),E=new Map;for(const n of l){const t=n.quantity||1,p=n.price*t;let I=h.get(n.category)||[];if(I.length===0){a.push({...n,quantity:t});continue}if(g+p>e){u.push({...n,quantity:t});continue}if(I=I.filter(i=>{const c=C.get(i.id)||0;return!i.moneyCap||c+p<=i.moneyCap}),I.length===0){u.push({...n,quantity:t});continue}let A;if(f==="fair"){const i=[...I].sort((M,v)=>{const V=C.get(M.id)||0,R=C.get(v.id)||0;return V-R}),c=E.get(n.category);let r=0;if(c){const M=i.findIndex(v=>v.id===c);M>=0&&(r=(M+1)%i.length)}A=i[r],E.set(n.category,A.id)}else A=I.reduce((i,c)=>{const r=C.get(i.id)||0;return(C.get(c.id)||0)<r?c:i});s.push({taskId:n.id,employeeId:A.id});const y=C.get(A.id)||0;C.set(A.id,y+p),g+=p}const o=s.length,q=u.length+a.length,w=e>0?g/e*100:0,k=m.length;return{assignments:s,unassigned:{budgetLimit:u,noMatch:a},totalUsed:g,statistics:{totalTasks:k,assignedTasks:o,unassignedTasks:q,budgetUtilization:w}}},U=(d,m,e,f,h)=>{if(e.find(o=>o.taskId===d.id&&o.employeeId===m.id))return{valid:!0};const u=e.filter(o=>o.taskId!==d.id).map(o=>o.taskId),g=f.filter(o=>u.includes(o.id)).reduce((o,q)=>o+q.price*(q.quantity||1),0),C=d.quantity||1,l=d.price*C;if(!e.some(o=>o.taskId===d.id)&&g+l>h)return{valid:!1,reason:`Vượt quá ngân sách (${(g+l).toLocaleString("vi-VN")} / ${h.toLocaleString("vi-VN")} VND)`};if(m.moneyCap){const{totalCompensation:o}=F(m.id,e,f);if(o+l>m.moneyCap)return{valid:!1,reason:`Vượt quá hạn mức nhân viên (${(o+l).toLocaleString("vi-VN")} / ${m.moneyCap.toLocaleString("vi-VN")} VND)`}}return{valid:!0}},F=(d,m,e)=>{const f=m.filter(a=>a.employeeId===d).map(a=>a.taskId),h=e.filter(a=>f.includes(a.id)),s=h.reduce((a,g)=>a+(g.quantity||1),0),u=h.reduce((a,g)=>a+g.price*(g.quantity||1),0);return{taskCount:s,totalCompensation:u,tasks:h}};export{Q as a,U as c};
