import{r as l,j as e,b as J}from"./ui-vendor-D2FDxrtI.js";import{B as k}from"./button-C12IU9SF.js";import{S as Q,P as X,C as Y}from"./ProjectSummary-DkDj194v.js";import{g as Z,C as _}from"./CategoryChip-BXzsdSKX.js";import{u as ee}from"./index-Bwlh9LrA.js";import{a as te,b as se,c as re}from"./csvParser-DapJ723n.js";import{D as ae,h as ne,i as le,j as D,k as L,a as ie,c as oe}from"./icons-DwHU0r-f.js";import"./react-vendor-DlBnNAMw.js";import"./charts-kvH0Okn1.js";import"./utils-B7X1E_CZ.js";const be=()=>{const{originalTasks:d,setOriginalTasks:g,nextStep:q,prevStep:z,getBudget:E}=ee(),m=E(),[b,j]=l.useState(null),[o,N]=l.useState(d||[]),[v,u]=l.useState([]),[x,i]=l.useState([]),[S,c]=l.useState([]),[P,h]=l.useState(!1),[M,f]=l.useState(!1),[y,$]=l.useState(new Set),C=l.useRef(null),V=async t=>{if(!t.name.match(/\.(csv|tsv)$/i)){i(["Vui lòng chọn file CSV hoặc TSV"]);return}if(t.size>10*1024*1024){i(["File vượt quá kích thước tối đa 10MB"]);return}j(t),h(!0),i([]),c([]);try{const s=await re(t);N(s.tasks),g(s.tasks),u(s.categories),i(s.errors),c(s.warnings);const r=s.tasks.reduce((n,a)=>n+a.price*(a.quantity||1),0);r>m&&c(n=>[...n,`Tổng giá trị công việc (${r.toLocaleString("vi-VN")} ₫) vượt quá ngân sách (${m.toLocaleString("vi-VN")} ₫)`])}catch{i(["Lỗi không xác định khi xử lý file"])}finally{h(!1)}},A=t=>{t.preventDefault(),t.stopPropagation(),f(!0)},B=t=>{t.preventDefault(),t.stopPropagation(),f(!1)},I=t=>{t.preventDefault(),t.stopPropagation()},F=t=>{t.preventDefault(),t.stopPropagation(),f(!1);const s=t.dataTransfer.files[0];s&&V(s)},G=t=>{const s=t.target.files?.[0];s&&V(s)},K=async()=>{h(!0),i([]),c([]),j(null);try{const t=await se();N(t.tasks),g(t.tasks),u(t.categories),i(t.errors),c(t.warnings);const s=t.tasks.reduce((r,n)=>r+n.price*(n.quantity||1),0);s>m&&c(r=>[...r,`Tổng giá trị công việc (${s.toLocaleString("vi-VN")} ₫) vượt quá ngân sách (${m.toLocaleString("vi-VN")} ₫)`])}catch{i(["Lỗi không xác định khi tải dữ liệu mẫu"])}finally{h(!1)}},R=()=>{o.length>0&&x.length===0&&(g(o),q())},O=o.length>0&&x.length===0,U=o.reduce((t,s)=>t+s.price*(s.quantity||1),0),w=o.reduce((t,s)=>s.unbreakable?t+1:t+(s.quantity||1),0),T=l.useMemo(()=>{const t=new Map;return o.forEach(s=>{t.has(s.category)||t.set(s.category,{category:s.category,tasks:[],totalValue:0,color:Z(s.category)});const r=t.get(s.category);r.tasks.push(s),r.totalValue+=s.price*(s.quantity||1)}),Array.from(t.values()).sort((s,r)=>s.category.localeCompare(r.category))},[o]),W=t=>{const s=new Set(y);s.has(t)?s.delete(t):s.add(t),$(s)};return l.useEffect(()=>{if(d&&d.length>0&&v.length===0){const t=new Map;d.forEach(r=>{const n=t.get(r.category)||{taskCount:0,totalValue:0},a=r.quantity||1,p=r.unbreakable?1:a;t.set(r.category,{taskCount:n.taskCount+p,totalValue:n.totalValue+r.price*a})});const s=Array.from(t.entries()).map(([r,n])=>({name:r,taskCount:n.taskCount,totalValue:n.totalValue}));u(s)}},[d,v.length]),e.jsx("div",{className:"min-h-screen flex flex-col items-center justify-center px-6 py-12",children:e.jsxs("div",{className:"w-full max-w-full md:max-w-[85%]",children:[e.jsx(Q,{currentStep:2,totalSteps:5,onPrev:z,onNext:R,canGoNext:O,nextLabel:"Tiếp tục"}),e.jsx(X,{}),e.jsxs(Y,{children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-semibold mb-2",children:"Nhập danh sách công việc"}),e.jsx("p",{className:"text-base text-text-secondary",children:"Tải lên file CSV/TSV chứa thông tin công việc và giá trị"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(k,{variant:"outline",onClick:K,icon:ae,title:"Sử dụng dữ liệu mẫu"}),e.jsx(k,{variant:"outline",onClick:async()=>{try{await te()}catch{i(["Không thể tải file mẫu. Vui lòng thử lại sau."])}},icon:ne,title:"Tải xuống file mẫu"})]})]}),e.jsxs("div",{className:`border-2 border-dashed border-primary/30 p-8 text-center cursor-pointer transition-all duration-200 rounded-xl ${M?"bg-primary/5 border-primary":"bg-white hover:border-primary/50"}`,onDragEnter:A,onDragOver:I,onDragLeave:B,onDrop:F,onClick:()=>C.current?.click(),children:[e.jsx("input",{ref:C,type:"file",accept:".csv,.tsv",onChange:G,className:"hidden","aria-label":"Chọn file CSV hoặc TSV"}),e.jsx(le,{className:"mx-auto mb-4",size:48,strokeWidth:2}),e.jsx("p",{className:"text-lg font-semibold mb-2",children:b?b.name:"Kéo thả file hoặc nhấp để chọn"}),e.jsx("p",{className:"text-sm text-text-secondary",children:"Định dạng: CSV hoặc TSV (tối đa 10MB)"})]}),P&&e.jsx("div",{className:"mt-6 text-center",children:e.jsx("p",{className:"text-base",children:"Đang xử lý file..."})}),x.length>0&&e.jsx("div",{className:"mt-6 bg-error/10 border border-error/30 text-error p-4 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(D,{className:"text-red-600 flex-shrink-0 mt-1",size:20}),e.jsxs("div",{children:[e.jsx("p",{className:"font-bold text-red-900 mb-2",children:"Lỗi:"}),e.jsx("ul",{className:"list-disc list-inside space-y-1",children:x.map((t,s)=>e.jsx("li",{className:"text-sm text-red-800",children:t},s))})]})]})}),S.length>0&&e.jsx("div",{className:"mt-6 bg-error/10 border border-error/30 text-error p-4 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(D,{className:"text-yellow-600 flex-shrink-0 mt-1",size:20}),e.jsxs("div",{children:[e.jsx("p",{className:"font-bold text-yellow-900 mb-2",children:"Cảnh báo:"}),e.jsx("ul",{className:"list-disc list-inside space-y-1",children:S.map((t,s)=>e.jsx("li",{className:"text-sm text-yellow-800",children:t},s))})]})]})}),o.length>0&&e.jsxs("div",{className:"mt-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(L,{className:"text-green-600",size:24}),e.jsxs("p",{className:"font-semibold text-lg",children:["Tìm thấy ",w," công việc"]})]}),e.jsx("div",{className:"overflow-x-auto border border-neutral-grey-medium rounded-lg",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-primary text-white",children:[e.jsx("th",{className:"px-4 py-2 text-left text-sm font-semibold",children:"STT"}),e.jsx("th",{className:"px-4 py-2 text-left text-sm font-semibold",children:"Tên công việc"}),e.jsx("th",{className:"px-4 py-2 text-left text-sm font-semibold",children:"KCN"}),e.jsx("th",{className:"px-4 py-2 text-left text-sm font-semibold",children:"Đơn giá"}),e.jsx("th",{className:"px-4 py-2 text-left text-sm font-semibold",children:"SL"}),e.jsx("th",{className:"px-4 py-2 text-left text-sm font-semibold",children:"Thành tiền"})]})}),e.jsxs("tbody",{children:[T.map(t=>{const s=y.has(t.category);let r=1;return T.filter(a=>a.category.localeCompare(t.category)<0).forEach(a=>{y.has(a.category)||(r+=a.tasks.length)}),e.jsxs(J.Fragment,{children:[e.jsx("tr",{className:"cursor-pointer hover:bg-neutral-grey-light",onClick:()=>W(t.category),children:e.jsx("td",{colSpan:6,className:"px-4 py-3 text-sm bg-primary/10 border-t-2 border-primary font-semibold",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[s?e.jsx(ie,{size:20}):e.jsx(oe,{size:20}),e.jsx(_,{category:t.category,size:"md"}),e.jsxs("span",{children:[t.tasks.length," công việc"]})]}),e.jsxs("span",{className:"text-sm",children:["Tổng: ",t.totalValue.toLocaleString("vi-VN")," ₫"]})]})})}),!s&&t.tasks.map((a,p)=>{const H=r+p;return e.jsxs("tr",{className:p%2===0?"bg-white":"bg-neutral-grey-light",children:[e.jsx("td",{className:"px-4 py-2 text-sm border-t border-neutral-grey-medium",children:H}),e.jsx("td",{className:"px-4 py-2 text-sm border-t border-neutral-grey-medium",children:a.name}),e.jsx("td",{className:"px-4 py-2 border-t border-neutral-grey-medium text-center",children:a.unbreakable?e.jsx(L,{size:18,className:"text-emerald-600 inline-block","aria-label":"Không thể chia nhỏ"}):e.jsx("span",{className:"text-text-muted",children:"-"})}),e.jsxs("td",{className:"px-4 py-2 text-sm border-t border-neutral-grey-medium",children:[a.price.toLocaleString("vi-VN")," ₫"]}),e.jsx("td",{className:"px-4 py-2 text-sm border-t border-neutral-grey-medium text-center",children:a.quantity||1}),e.jsxs("td",{className:"px-4 py-2 text-sm border-t border-neutral-grey-medium font-semibold",children:[(a.price*(a.quantity||1)).toLocaleString("vi-VN")," ₫"]})]},a.id)})]},t.category)}),e.jsxs("tr",{className:"bg-primary text-white",children:[e.jsxs("td",{className:"px-4 py-3 border-t-2 border-primary text-sm font-semibold",colSpan:5,children:["Tổng cộng ",w," công việc"]}),e.jsxs("td",{className:"px-4 py-3 border-t-2 border-primary text-sm font-semibold",children:[U.toLocaleString("vi-VN")," ₫"]})]})]})]})})]})]})]})})};export{be as TaskImportScreen};
